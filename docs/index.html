<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Clapp_Kephart_Gonzalez_Project: Clapp_Kephart_Gonzalez_Project</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Clapp_Kephart_Gonzalez_Project
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Clapp_Kephart_Gonzalez_Project </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="sec_intro"></a>
ME 405 Term Project Software Description</h1>
<p >This is our project main page for the ME 405 plotter project, and the progress we have made up to this point on the software side of the project.</p>
<p >Our Source Code Repository can be found:  <a href="https://github.com/dcejagon/Term-Project/blob/a13c4d475a7929b415f7536712c5a4d967adee70/src">HERE</a> </p>
<h1><a class="anchor" id="sec_lb1"></a>
Task Diagram and File Structure</h1>
<p >We developed the Task Diagram seen below to demonstrate the file structure that we plan to use in our 2.5D plotter. Each of the files will have some combination of shares and/or queues in order to allow for variable data to be shared between files. The exact shares between files is shown in the diagram. We will utilize this by using the Task_Shares.py file that we have been provided to ensure the shared variables are set up correctly, and contain usable data. In addition, we plan to have the differnet tasks communicate with eachother using the structure outlined in previous labs and by using CoTasks.py to make sure we are taking advantage of cooperative multitasking. To simplify what is going on in each of our files, we are only using FSMs at the task level. We have one for task2 MotorControl Task and task3 ServoMotor Task. These diagrams are shown in ThetaMotorControl.py and RMotorControl.py and ServoMotorF.py sections respectively.</p>
<p >The files that we are using are: main Main file that runs all of our tasks and instantiates all objects EncoderDriver Read the position of the Theta Motor Encoder Read the position of the R Motor MotorDriver Control the motor by supplying a duty ThetaMotorControl Closed loop control of Theta Motor RMotorControl Closed loop control of R Motor ServoMotorF Control the servo motor responsible for our half axis as well as limit switch reading GcodeInterpreter Writed R and Theta Setpoints to .txt file to be read later</p>
<p >The Task Diagram showing how these files are used is shown below.</p>
<div class="image">
<img src="OverallTaskDiagram.png" alt="" width="900px"/>
<div class="caption">
Overall Task Diagram </div></div>
<div class="image">
<img src="SubTaskDiagram.png" alt="" width="900px"/>
<div class="caption">
Sub-Task Diagram</div></div>
<p >The frist image shows the Overall Task Diagram that is running in our system, and the second shows the subtasks that are running inside of each task. We are running 3 tasks, each represented by a different color box, Blue is task1, Red is task2, and Green is task3. If there are multiple boxes of the same color, they are treated as subtasks. Each of this subtasks and their shares is shown in the second picture. Each of the shares we are using is represented with a dashed line pointing from where the variable is written to where the variable is read. We chose to split the task diagram up this way so that it better demonstrated what is happening with each share.</p>
<p >The procedure on how we used our code is shown below:</p><ol type="1">
<li>Create GCODE using <a href="http://jscut.org/jscut.html#">http://jscut.org/jscut.html#</a> by converting a .SVG to tool paths</li>
<li>Save the .gcode file that was created as NAME.txt</li>
<li>Run NAME.text through GcodeInterpreter.py to output text files for desired R and Theta motor angles</li>
<li>Save all necessary files on the Nucleo</li>
<li>Run main.py on the Nucleo to use the plotter <br  />
 a. main.py uses cotask.py for cooperative multitasking. <br  />
 b. Task1 generates the setpoint for both motors <br  />
 c. Task2 calculates encoder position, runs closed loop controller, and runs motor driver with duty from the controller <br  />
 d. Task3 controls the servo motor. If we want to draw, Zpos=1, if we want to lift, Zpos=0 <br  />
 e. Repeat running all tasks until the ends of the setpoint text files are reached <br  />
</li>
</ol>
<h1><a class="anchor" id="sec_lb2"></a>
main.py</h1>
<p >This file is the starting point of all of our software. We set up all needed hardware to software interface (pins and timers), set up our shared variables, and instantiate all objects. This file also contains the generator responsibile for running all of our tsaks cooperatively.</p>
<h1><a class="anchor" id="sec_lb3"></a>
EncoderDriver.py and Encoder.py</h1>
<p >These two files are very similar, the only differnece is that EncoderDriver.py reads the Theta encoder and Encoder.py reads only the R encoder. These files are only used to calculate encoder position. When we read the encoder position, we write that value to a shared variable for each position. For ThetaEncoderPosition.write(EncoderPosition). We calcualte this encoder position by calculating the encoder delta from a timer on the microcontroller and the previous time. This allows us to calculate encoder position without worrying about the encoder "overflowing," where the encoder position essentially resets to 0 once the reading reaches 65535. We decided to split EncoderDriver.py and Encoder.py to make it easy to troubleshoot any errors that may come up. Origionally, EncoderDriver.py was responsible for reading both encoder positions, so that is why it has R encoder pins, timer, and shares passed into the class, but they are never used. Similarly, since we only need R motor stuff passed into Encoder, we changed that file to only have necessary values shared to that file. In short, instead of changing EncoderDriver.py from its origional state, we left it as is, and created a single copy that would only be used for the R motor and deleted all information related to the Theta motor.</p>
<h1><a class="anchor" id="sec_lb4"></a>
MotorDriver.py</h1>
<p >This file is responsible for taking the duty input from other files and making the motors turn at that duty. Once the motor driver is instantiated, the methodd that are called repeatidly are set_duty_cycle and set_duty_cycle2 (one for R motor and 1 for Theta motor). These methods enable the motor by setting the enable pin to high, and also sets both output pins to low. We then set the duty by changing the PWM % to the desired duty value. If the desired duty is positive, we set the PWM duty cycle of channel1, but if it is negative, e set the PWM duty cycle of channel2. The pin that does not have the duty cycle applied to it is set to a duty of 0. Example (Positive duty-&gt; CH1.pule_width_percent(DUTY) and CH2.pule_width_percent(0))</p>
<h1><a class="anchor" id="sec_lb5"></a>
ThetaMotorControl.py and RMotorControl.py</h1>
<p >These two files are responsible for all of our closed loop system control. We are using a simple porportional controller with gain Kp. The control loop that is run over and over calculated the error signal (error=setpoint-EncoderPosition), multiplies that by gain, Kp, and then sets the duty to this value, called the actuation signal. This file is necessary to determine when our motor reaches the desired position. In addition, these files determine when motor position gets within an acceptable range. Once this happens, we set a buffer variable to true so that our code konws when it should generate a new setpoint.</p>
<p >The FSM for the Motor Tasks (including EncoderDriver.py, Control Loops, and MotorDriver.py) is shown below. </p><div class="image">
<img src="MotorControlFSM.png" alt="" width="900px"/>
<div class="caption">
FSMs for Motor Control Task</div></div>
<h1><a class="anchor" id="sec_lb6"></a>
ServoMotorF.py</h1>
<p >This file is responsible for controling our servo motor and limit switch. We have classes for both the servo motor, and the limit switch. The servo motor class contains methods to raise and lower the servo motor called up() and down(). These methods are called in main when a certain Zpos variable changes value. For example, when Zpos=1, the servo motor will move down.</p>
<p >The limit switch class is responsible for reading the value output by the limit switch pins. This is done in the method checkswitch(). This checks the value of the pin using the .value call for the pin. Since the switch was wired to be normally closed, when there is nothing pressing the switch, pin.value()=1, but when it is pressed, pin.value()=0. We are using this limit switch as a kill switch, so when the value of the pin is 0, we set the duty of the R motor to 0 to prevent the hardware from tearing itself apart.</p>
<p >The FSM for this file is shown below </p><div class="image">
<img src="ServoFSM.png" alt="" width="900px"/>
<div class="caption">
FSMs for Servo Motor</div></div>
<h1><a class="anchor" id="sec_lb7"></a>
GcodeInterpreter.py</h1>
<p >In order to generate the path that the pen should take, we used <a href="http://jscut.org/jscut.html#">http://jscut.org/jscut.html#</a> , a website that accepts SVG images and converts it to GCODE. This website was nice, because each of the GCODE lines were G1, which is the call for a straight line. The GCODE that this website outputs is a series of straight lines that are very short (around 0.001"). This means, we essentially have a list of X-Y coordinates that trace out our image.</p>
<p >We then use the file GcodeInterpreter.py, to take each line of GCODE, pull out the desired X-Y coordinates, and then preform some math to convert these to R-Theta coordinates. From these R-Theta coordinates, we use our known gear ratios to write the desired R Motor angle and Theta Motor angle to their own .txt files.</p>
<p >We then read each line of these files in main.py to get the setpoint of both motors. This is only done when the motor has reached its previous setpoint and the buffer variable is set to 1.</p>
<dl class="section author"><dt>Author</dt><dd>Nolan Clapp </dd>
<dd>
Caleb Kephart </dd>
<dd>
Daniel Gonzalez </dd></dl>
<dl class="section date"><dt>Date</dt><dd>Feb 22, 2022 </dd></dl>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Sat Mar 12 2022 19:46:46 for Clapp_Kephart_Gonzalez_Project by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2 </li>
  </ul>
</div>
</body>
</html>
